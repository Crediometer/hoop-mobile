name: Hoop Mobile CI/CD Pipeline

on:
  push:
    branches: [dev, staging, main]
    tags:
      - 'v*'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'üè∑Ô∏è Version to release (format: X.Y.Z)'
        required: true
        type: string
        default: '1.0.0'
      build_number:
        description: 'üî¢ Build number'
        required: false
        type: string
        default: '1'
      environment:
        description: 'üåç Deploy to environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'staging'
      platforms:
        description: 'üì± Platforms to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
        default: 'both'

env:
  FLUTTER_VERSION: "3.35.1"
  # Cache keys
  FLUTTER_CACHE_KEY: "flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}"
  PUB_CACHE_KEY: "pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}"
  ANDROID_CACHE_KEY: "android-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle.properties') }}"
  IOS_PODS_CACHE_KEY: "ios-pods-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}"

jobs:
  # ========== SETUP & VALIDATION ==========
  setup:
    name: "üîç Setup & Validate"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.value }}
      build_number: ${{ steps.build-number.outputs.value }}
      environment: ${{ steps.environment.outputs.value }}
      is_release: ${{ steps.release-check.outputs.is_release }}
      is_tag: ${{ steps.release-check.outputs.is_tag }}
    
    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: "üíæ Cache Flutter SDK"
        id: cache-flutter
        uses: actions/cache@v3
        with:
          path: |
            /opt/hostedtoolcache/flutter
            ${{ runner.tool_cache }}/flutter
          key: ${{ env.FLUTTER_CACHE_KEY }}
          restore-keys: |
            flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}
            flutter-${{ runner.os }}
      
      - name: "üì¶ Setup Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: ${{ env.FLUTTER_CACHE_KEY }}
          cache-path: ${{ runner.tool_cache }}/flutter
      
      - name: "üíæ Cache pub dependencies"
        id: cache-pub
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            ${{ runner.tool_cache }}/flutter/.pub-cache
            .dart_tool
          key: ${{ env.PUB_CACHE_KEY }}
          restore-keys: |
            pub-cache-${{ runner.os }}-
      
      - name: "üì¶ Get dependencies"
        run: |
          flutter pub get
          echo "Dependencies restored from cache: ${{ steps.cache-pub.outputs.cache-hit }}"
      
      - name: "üß™ Run tests"
        run: |
          flutter test --coverage --test-randomize-ordering-seed=random || echo "Tests may have failed, continuing with build"
      
      - name: "üîç Analyze code"
        run: flutter analyze
      
      - name: "üè∑Ô∏è Check release type"
        id: release-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi
      
      - name: "üìå Determine version"
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "value=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/v}
            echo "value=$TAG_VERSION" >> $GITHUB_OUTPUT
          else
            PUBSPEC_VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
            echo "value=$PUBSPEC_VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Version: ${{ steps.version.outputs.value }}"
      
      - name: "üî¢ Determine build number"
        id: build-number
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.build_number }}" ]]; then
            echo "value=${{ github.event.inputs.build_number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "value=$(date +%Y%m%d%H%M)" >> $GITHUB_OUTPUT
          else
            echo "value=${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi
          echo "Build number: ${{ steps.build-number.outputs.value }}"
      
      - name: "üåç Determine environment"
        id: environment
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "value=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "value=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "value=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "staging" ]]; then
            echo "value=staging" >> $GITHUB_OUTPUT
          else
            echo "value=development" >> $GITHUB_OUTPUT
          fi
          echo "Environment: ${{ steps.environment.outputs.value }}"
      
      - name: "üìù Update pubspec.yaml with version"
        if: steps.release-check.outputs.is_release == 'true'
        run: |
          FULL_VERSION="${{ steps.version.outputs.value }}+${{ steps.build-number.outputs.value }}"
          sed -i "s/version: .*/version: $FULL_VERSION/" pubspec.yaml
          echo "‚úÖ Updated pubspec.yaml to version: $FULL_VERSION"

  # ========== ANDROID BUILD ==========
  android:
    name: "ü§ñ Android"
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.is_release == 'true' && (github.event.inputs.platforms == 'android' || github.event.inputs.platforms == 'both')
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4
      
      - name: "üíæ Cache Flutter SDK"
        uses: actions/cache@v3
        with:
          path: |
            /opt/hostedtoolcache/flutter
            ${{ runner.tool_cache }}/flutter
          key: ${{ env.FLUTTER_CACHE_KEY }}
          restore-keys: |
            flutter-${{ env.FLUTTER_VERSION }}-${{ runner.os }}
      
      - name: "üì¶ Setup Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: ${{ env.FLUTTER_CACHE_KEY }}
      
      - name: "üíæ Cache pub dependencies"
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ env.PUB_CACHE_KEY }}
      
      - name: "üì¶ Get dependencies"
        run: |
          flutter pub get
          echo "Flutter dependencies installed"
      
      - name: "üíæ Cache Android Gradle"
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      
      - name: "üíæ Cache Android build"
        uses: actions/cache@v3
        with:
          path: |
            android/.gradle
            android/build
            android/app/build
          key: ${{ env.ANDROID_CACHE_KEY }}
          restore-keys: |
            android-${{ runner.os }}-
      
      - name: "üìù Apply version"
        run: |
          FULL_VERSION="${{ needs.setup.outputs.version }}+${{ needs.setup.outputs.build_number }}"
          sed -i "s/version: .*/version: $FULL_VERSION/" pubspec.yaml
          echo "Building version: $FULL_VERSION"
      
      - name: "üîê Setup Android signing"
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload.jks
            echo "‚úÖ Keystore created"
          else
            echo "‚ö†Ô∏è No keystore provided, building unsigned AAB"
          fi
      
      - name: "üîë Create key.properties"
        if: secrets.ANDROID_KEYSTORE_BASE64
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload.jks
          EOF
          echo "‚úÖ key.properties created"
      
      - name: "üèóÔ∏è Build Android App Bundle"
        run: |
          # Pre-warm Gradle
          cd android && ./gradlew --version && cd ..
          
          echo "Building Android App Bundle..."
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "Building signed release AAB..."
            flutter build appbundle --release --no-tree-shake-icons
          else
            echo "Building unsigned AAB..."
            flutter build appbundle --release --no-tree-shake-icons
          fi
          
          echo "‚úÖ AAB built successfully"
          ls -la build/app/outputs/bundle/*release/*.aab 2>/dev/null || ls -la build/app/outputs/bundle/*debug/*.aab
      
      - name: "üíæ Cache Ruby gems"
        uses: actions/cache@v3
        with:
          path: |
            android/vendor/bundle
            ~/.gem
          key: gems-${{ runner.os }}-android-${{ hashFiles('android/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-android-
      
      - name: "‚ö° Setup Ruby and Fastlane"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          cache-version: 2
          working-directory: ./android
      
      - name: "üöÄ Deploy to Play Store"
        if: needs.setup.outputs.environment != 'development' && secrets.PLAY_STORE_JSON
        env:
          PLAY_STORE_JSON: ${{ secrets.PLAY_STORE_JSON }}
        run: |
          if [ -n "$PLAY_STORE_JSON" ]; then
            # Save Google Play JSON key
            echo "$PLAY_STORE_JSON" > android/play.json
            
            # Create Fastlane Appfile if it doesn't exist
            if [ ! -f "android/fastlane/Appfile" ]; then
              echo "Creating Fastlane Appfile..."
              cat <<EOF > android/fastlane/Appfile
          json_key_file("play.json")
          # Update with your actual package name from android/app/build.gradle
          package_name("com.yourcompany.hoopmobile")
          EOF
            fi
            
            # Check AAB file exists
            if [ ! -f "build/app/outputs/bundle/release/app-release.aab" ]; then
              echo "‚ö†Ô∏è AAB not found at expected path, searching..."
              find build/app/outputs/bundle -name "*.aab" -exec echo "Found: {}" \;
            fi
            
            cd android
            
            ENV="${{ needs.setup.outputs.environment }}"
            echo "üì± Deploying to Play Store ($ENV)..."
            
            case "$ENV" in
              "staging")
                echo "Using Beta track..."
                bundle exec fastlane beta || echo "Fastlane beta failed"
                ;;
              "production")
                echo "Using Production track..."
                bundle exec fastlane release || echo "Fastlane release failed"
                ;;
              *)
                echo "Using Internal track..."
                bundle exec fastlane internal || echo "Fastlane internal failed"
                ;;
            esac
          else
            echo "‚ö†Ô∏è No Play Store credentials provided, skipping deployment"
          fi
      
      - name: "üì§ Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
          path: |
            build/app/outputs/bundle/*release/*.aab
            build/app/outputs/bundle/*debug/*.aab
          retention-days: 30
          if-no-files-found: error

  # ========== iOS BUILD ==========
  ios:
    name: "üçé iOS"
    runs-on: macos-latest
    needs: setup
    if: needs.setup.outputs.is_release == 'true' && (github.event.inputs.platforms == 'ios' || github.event.inputs.platforms == 'both')
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: "üì• Checkout code"
        uses: actions/checkout@v4
      
      - name: "üíæ Cache Flutter SDK"
        uses: actions/cache@v3
        with:
          path: |
            /opt/hostedtoolcache/flutter
            ${{ runner.tool_cache }}/flutter
          key: ${{ env.FLUTTER_CACHE_KEY }}-macos
          restore-keys: |
            flutter-${{ env.FLUTTER_VERSION }}-macos
      
      - name: "üì¶ Setup Flutter"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
          cache-key: ${{ env.FLUTTER_CACHE_KEY }}-macos
      
      - name: "üíæ Cache pub dependencies"
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ env.PUB_CACHE_KEY }}-macos
      
      - name: "üì¶ Get Flutter dependencies"
        run: flutter pub get
      
      - name: "üíæ Cache CocoaPods"
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: ${{ env.IOS_PODS_CACHE_KEY }}
          restore-keys: |
            ios-pods-${{ runner.os }}-
      
      - name: "üì¶ Install CocoaPods"
        run: |
          cd ios
          if [ -f "Podfile.lock" ] && [ -d "Pods" ]; then
            echo "Using cached Pods"
            pod install --repo-update
          else
            echo "Installing Pods from scratch"
            pod install
          fi
          cd ..
      
      - name: "üíæ Cache Xcode build"
        uses: actions/cache@v3
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ios/build
          key: xcode-${{ runner.os }}-${{ hashFiles('ios/**/*.xcodeproj/**', 'ios/**/*.xcworkspace/**') }}
          restore-keys: |
            xcode-${{ runner.os }}-
      
      - name: "üìù Apply version"
        run: |
          FULL_VERSION="${{ needs.setup.outputs.version }}+${{ needs.setup.outputs.build_number }}"
          sed -i "" "s/version: .*/version: $FULL_VERSION/" pubspec.yaml
          echo "Building version: $FULL_VERSION"
      
      - name: "üîê Setup iOS code signing"
        if: secrets.IOS_CERTIFICATE_BASE64
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_BASE64: ${{ secrets.IOS_PROVISIONING_BASE64 }}
        run: |
          # Create keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Import certificate if provided
          if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
            echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
            security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          else
            echo "‚ö†Ô∏è No certificate provided, using automatic signing"
          fi
          
          # Import provisioning profile if provided
          if [ -n "$IOS_PROVISIONING_BASE64" ]; then
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$IOS_PROVISIONING_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          fi
          
          # Configure keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          
          echo "‚úÖ iOS code signing setup complete"
      
      - name: "üèóÔ∏è Build iOS IPA"
        run: |
          echo "Building iOS IPA..."
          xcodebuild -version
          
          if [ -n "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ]; then
            flutter build ipa --release --no-tree-shake-icons
          else
            flutter build ipa --debug --no-tree-shake-icons
          fi
          
          echo "‚úÖ IPA built successfully"
          if [ -d "build/ios/ipa" ]; then
            ls -la build/ios/ipa/
          else
            echo "‚ö†Ô∏è IPA directory not found, checking alternative locations..."
            find build/ios -name "*.ipa" -exec echo "Found: {}" \;
          fi
      
      - name: "üíæ Cache Ruby gems (iOS)"
        uses: actions/cache@v3
        with:
          path: |
            ios/vendor/bundle
            ~/.gem
          key: gems-${{ runner.os }}-ios-${{ hashFiles('ios/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ios-
      
      - name: "‚ö° Setup Ruby and Fastlane (iOS)"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          cache-version: 2
          working-directory: ./ios
      
      - name: "üöÄ Deploy to TestFlight/App Store"
        if: needs.setup.outputs.environment != 'development' && secrets.APP_STORE_KEY_ID
        env:
          APP_STORE_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          APP_STORE_PRIVATE_KEY: ${{ secrets.APP_STORE_PRIVATE_KEY }}
        run: |
          if [ -n "$APP_STORE_KEY_ID" ] && [ -n "$APP_STORE_ISSUER_ID" ] && [ -n "$APP_STORE_PRIVATE_KEY" ]; then
            cd ios
            
            # Save App Store Connect API key
            cat <<EOF > api_key.json
            {
              "key_id": "$APP_STORE_KEY_ID",
              "issuer_id": "$APP_STORE_ISSUER_ID",
              "key": "$APP_STORE_PRIVATE_KEY"
            }
            EOF
            
            ENV="${{ needs.setup.outputs.environment }}"
            echo "üì± Deploying to App Store Connect ($ENV)..."
            
            case "$ENV" in
              "staging")
                echo "Deploying to TestFlight (External)..."
                bundle exec fastlane beta || echo "Fastlane beta failed"
                ;;
              "production")
                echo "Deploying to App Store..."
                bundle exec fastlane release || echo "Fastlane release failed"
                ;;
              *)
                echo "Deploying to TestFlight (Internal)..."
                bundle exec fastlane internal || echo "Fastlane internal failed"
                ;;
            esac
          else
            echo "‚ö†Ô∏è No App Store Connect credentials provided, skipping deployment"
          fi
      
      - name: "üì§ Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 30
          if-no-files-found: error

  # ========== NOTIFICATION ==========
  notify:
    name: "üì¢ Notification"
    runs-on: ubuntu-latest
    needs: [setup, android, ios]
    if: always()
    
    steps:
      - name: "üìä Build status summary"
        run: |
          echo "=== CI/CD Pipeline Summary ==="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run: ${{ github.run_number }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "Version: ${{ needs.setup.outputs.version }}+${{ needs.setup.outputs.build_number }}"
          echo "Environment: ${{ needs.setup.outputs.environment }}"
          echo "Release Build: ${{ needs.setup.outputs.is_release }}"
          echo ""
          echo "Job Status:"
          echo "- Setup: ${{ needs.setup.result }}"
          echo "- Android: ${{ needs.android.result }}"
          echo "- iOS: ${{ needs.ios.result }}"
          echo ""
          echo "Build completed at: $(date)"
          echo ""
          echo "View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: "üì± Send Slack notification"
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Flutter CI/CD Pipeline Complete",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n`${{ github.repository }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`${{ needs.setup.outputs.version }}+${{ needs.setup.outputs.build_number }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n`${{ needs.setup.outputs.environment }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Android:*\n${{ needs.android.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*iOS:*\n${{ needs.ios.result }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Artifacts:*\nDownload from GitHub Actions artifacts"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Run: ${{ github.run_number }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK